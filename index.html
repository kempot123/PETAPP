<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pet Me Admin</title>
    <!--Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!--Datatables-->
    <link href="https://cdn.datatables.net/v/bs5/dt-2.0.0/b-3.0.0/b-html5-3.0.0/datatables.min.css" rel="stylesheet">
</head>
<body>
    <!--Nav-->
    <nav class="navbar bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <!--img src="/images/logo.png" alt="Pet Me" width="30" height="24"-->
                <span class="text-white">Pet Me</span>
            </a>
        </div>
    </nav>

    <div class="row vh-100">
        <!--Menu-->
        <div class="col-md-2 bg-light p-0 shadow-sm">
            <ul class="list-group">
                <li id="registeredPetsMenuItem" class="list-group-item d-flex justify-content-between align-items-start px-4 py-3 menu-item" data-page="registered_pets">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Registered Pets</div>
                    </div>
                    <span id="registeredPetsBadge" class="badge text-bg-danger rounded-pill"></span>
                </li>
                <li id="adoptedPetsMenuItem" class="list-group-item d-flex justify-content-between align-items-start px-4 py-3 menu-item" data-page="adopted_pets">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Adopted Pets</div>
                    </div>
                    <span id="adoptedPetsBadge" class="badge text-bg-danger rounded-pill"></span>
                </li>
                <li id="lostPetsMenuItem" class="list-group-item d-flex justify-content-between align-items-start px-4 py-3 menu-item" data-page="lost_pets">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Lost Pets</div>
                    </div>
                    <span class="badge text-bg-danger rounded-pill"></span>
                </li>
                <li id="petMemorialsMenuItem" class="list-group-item d-flex justify-content-between align-items-start px-4 py-3 menu-item" data-page="pet_memorials">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Pet Memorials</div>
                    </div>
                    <span class="badge text-bg-danger rounded-pill"></span>
                </li>
                <li id="usersMenuItem" class="list-group-item d-flex justify-content-between align-items-start px-4 py-3 menu-item" data-page="users">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">Users</div>
                    </div>
                    <span class="badge text-bg-danger rounded-pill"></span>
                </li>
            </ul>

        </div>
        <!--Content-->
        <div class="col-md p-5 mx-5">

            <div id="registeredPetsContent" class="d-none">
                <h3 id="registeredPetsTitle" class="mb-3">Registered Pets</h3>
                <table id="petsTable" class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Owner</th>
                            <th>Image</th>
                            <th>Address</th>
                            <th>Contact</th>
                            <th>Breed</th>
                            <th>Is Kapon?</th>
                            <th>Is Vaccinated?</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="adoptedPetsContent" class="d-none">
                <h3 id="adoptedPetsTitle" class="mb-3">Adopted Pets</h3>
                <table id="adoptedPetsTable" class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Image</th>
                            <th>Owner</th>
                            <th>Foster</th>
                            <th>Address</th>
                            <th>Breed</th>
                            <th>Description</th>
                            <th>Is Adopted?</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="lostPetsContent" class="d-none">
                <h3 id="lostPetsTitle" class="mb-3">Lost Pets</h3>
                <table id="lostPetsTable" class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Image</th>
                            <th>Owner</th>
                            <th>Contact</th>
                            <th>Address</th>
                            <th>Breed</th>
                            <th>Description</th>
                            <th>Is Found?</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="memorialPetsContent" class="d-none">
                <h3 id="memorialPetsTitle" class="mb-3">Memorial Pets</h3>
                <table id="memorialPetsTable" class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Owner</th>
                            <th>Birth Year</th>
                            <th>Death Year</th>
                            <th>Message</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div id="usersContent" class="d-none">
                <h3 id="usersContentTitle" class="mb-3">Users</h3>
                <table id="usersTable" class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email Address</th>
                            <th>Phone</th>
                            <th>Username</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!--Datatables-->
    <script src="https://cdn.datatables.net/v/bs5/dt-2.0.0/b-3.0.0/b-html5-3.0.0/datatables.min.js"></script>

    <script>
        class Notification {
            constructor(id, userId, message, isRead, timestamp, toId, userTo) {
                this.id = id;
                this.userId = userId;
                this.message = message;
                this.read = isRead;
                this.timestamp = timestamp;
                this.toId = toId;
            }
        }

        const StatusEnum = {
            PET_ADMIN_APPROVED: "PET_ADMIN_APPROVED",
            PET_ADMIN_UNAPPROVED: "PET_ADMIN_UNAPPROVED",
            LOST_FOUND_ADMIN_APPROVED: "LOST_FOUND_ADMIN_APPROVED",
            LOST_FOUND_ADMIN_UNAPPROVED: "LOST_FOUND_ADMIN_UNAPPROVED",
            MEMORIAL_ADMIN_APPROVED: "MEMORIAL_ADMIN_APPROVED",
            MEMORIAL_ADMIN_UNAPPROVED: "MEMORIAL_ADMIN_UNAPPROVED",
            ADOPTION_ADMIN_APPROVED: "ADOPTION_ADMIN_APPROVED",
            ADOPTION_ADMIN_UNAPPROVED: "ADOPTION_ADMIN_UNAPPROVED"
        };

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMlk56NayOuhLOx4H2T6_oLhaKJu8FJcE",
            authDomain: "pet-me-final.firebaseapp.com",
            databaseURL: "https://pet-me-final-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pet-me-final",
            storageBucket: "pet-me-final.appspot.com",
            messagingSenderId: "419569886982",
            appId: "1:419569886982:web:33cf0da4ecde41287b2087",
            measurementId: "G-ZDRW1HCFNZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Reference to your Firebase Realtime Database
        const database = firebase.database();

        // Variables
        let currentPage = "";
        let dataRef;

        // Call the setupMenuClickHandlers function when the document is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setupMenuClickHandlers();

            currentPage = new URLSearchParams(window.location.search).get('page');
            
            // Call function to hide all content divs
            hideAllContentDivs();

            let path = '';
            if (currentPage == 'registered_pets') {
                path += 'pets';
                $('#registeredPetsContent').removeClass('d-none').addClass('d-block');
            } else if (currentPage == 'adopted_pets') {
                path += 'adopted_pets';
                $('#adoptedPetsContent').removeClass('d-none').addClass('d-block');
            } else if (currentPage == 'lost_pets') {
                path += 'lost_pets';
                $('#lostPetsContent').removeClass('d-none').addClass('d-block');
            } else if (currentPage == 'pet_memorials') {
                path += 'memorials';
                $('#memorialPetsContent').removeClass('d-none').addClass('d-block');
            } else if (currentPage == 'users') {
                path += 'users';
                $('#usersContent').removeClass('d-none').addClass('d-block');
            }

            fetchData(path, function(data) {
                populateTables(data);
            });
        });

        // Function to hide all content divs
        function hideAllContentDivs() {
            $('#registeredPetsContent').removeClass('d-block').addClass('d-none');
            $('#adoptedPetsContent').removeClass('d-block').addClass('d-none');
            $('#lostPetsContent').removeClass('d-block').addClass('d-none');
            $('#petMemorialsContent').removeClass('d-block').addClass('d-none');
            $('#usersContent').removeClass('d-block').addClass('d-none');
        }

        // Function to add click event listeners to menu items
        function setupMenuClickHandlers() {
            $('.menu-item').on('click', function () {
                const page = $(this).data('page');

                // Call the navigateToPage function
                navigateToPage(page);
            });
        }

        // Function to navigate to a page with the given page parameter
        function navigateToPage(page) {
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            window.location.href = url.toString();
        }

        // Function to retrieve data from Firebase
        function fetchData(path, callback) {
            dataRef = database.ref(path);
            dataRef.on('value', function(snapshot) {
                const data = snapshot.val();
                callback(data);
            });
        }

        // Function to populate tables based on page parameter
        function populateTables(data) {
            console.log(data);
            const petTableBody = $('#petsTable tbody');
            const adoptedTableBody = $('#adoptedPetsTable tbody');
            const lostTableBody = $('#lostPetsTable tbody');
            const memorialTableBody = $('#memorialPetsTable tbody');
            const userTableBody = $('#usersTable tbody');
            petTableBody.empty(); // Clear previous data
            adoptedTableBody.empty(); // Clear previous data
            lostTableBody.empty(); // Clear previous data
            memorialTableBody.empty(); // Clear previous data
            userTableBody.empty(); // Clear previous data

            // Loop through the data and create table rows
            for (let key in data) {
                if (data.hasOwnProperty(key)) {
                    const rowData = data[key];
                    const petRow = petTableBody[0].insertRow();
                    const adoptedRow = adoptedTableBody[0].insertRow();
                    const lostRow = lostTableBody[0].insertRow();
                    const memorialRow = memorialTableBody[0].insertRow();
                    const userRow = userTableBody[0].insertRow();

                    // Populate table rows based on the page parameter
                    if (currentPage === 'registered_pets') {
                        populateRegisteredPetsTableRow(petRow, rowData, key);
                    } else if (currentPage === 'adopted_pets') {
                        populateAdoptedPetsTableRow(adoptedRow, rowData, key);
                    } else if (currentPage === 'lost_pets') {
                        populateLostPetsTableRow(lostRow, rowData, key);
                    } else if (currentPage === 'pet_memorials') {
                        populateMemorialPetsTableRow(memorialRow, rowData, key);
                    } else if (currentPage === 'users') {
                        populateUsersTableRow(userRow, rowData, key);
                    }
                    // Add more conditions for other pages if needed
                }
            }

            updateTable();
        }

        // Function to get current timestamp in milliseconds
        function getCurrentTimestamp() {
            // Get current date and time
            const currentDate = new Date();
            // Get timestamp in milliseconds since Unix epoch
            return currentDate.getTime().toString();
        }

        function addNotification(status, toId) {
            const notification = new Notification(
                null,
                toId,
                status,
                false,
                getCurrentTimestamp(),
                toId
            );

            return database.ref('notifs').push(notification)
                .then((newNotificationRef) => {
                    notification.id = newNotificationRef.key;
                    // Update the notification's ID in the database
                    return newNotificationRef.update({ id: notification.id })
                        .then(() => {
                            // Return the notification ID
                            return notification.id;
                        });
                });
        }

        function updateNotification(id, status, toId) {
            const notification = new Notification(
                id,
                toId,
                status,
                false,
                getCurrentTimestamp(),
                toId
            );

            return database.ref('notifs/' + id).update(notification)
                .then(() => {
                });
        }

        function handleApprovalStatus(key, rowData, adminApproved, adminUnapproved) {
            const id = key;
            const newApproveStatus = !rowData.approved;

            let notifId = "";
            if (rowData.notificationId != null) {
                 notifId = rowData.notificationId;
            }

            var status;
            if (newApproveStatus == true) {
                status = adminApproved;

                addNotification(status, rowData.userId)
                .then((notifId) => {
                    dataRef.child(id).update({ approved: newApproveStatus, notificationId: notifId });
                })
                .catch((error) => {
                }); 
            } else {
                status = adminUnapproved;
                updateNotification(notifId, status, rowData.userId)
                .then(() => {
                    dataRef.child(id).update({ approved: newApproveStatus});
                })
                .catch((error) => {
                }); 
            }
        }

        // Function to populate a table row with data
        function populateRegisteredPetsTableRow(row, rowData, key) {
            row.insertCell(0).textContent = rowData.name;
            row.insertCell(1).textContent = rowData.type;
            const ownerCell = row.insertCell(2);
            database.ref('users/' + rowData.userId).once('value').then(function(userSnapshot) {
                const userData = userSnapshot.val();
                if (userData) {
                    ownerCell.textContent = userData.name;
                } else {
                    ownerCell.textContent = 'Unknown';
                }
            });
            row.insertCell(3).innerHTML = `<img src="${rowData.imageUrl}" alt="Pet Image" style="max-width: 100px; max-height: 100px;">`;
            row.insertCell(4).textContent = rowData.address;
            row.insertCell(5).textContent = rowData.contact;
            row.insertCell(6).textContent = rowData.breed;
            row.insertCell(7).textContent = rowData.kapon ? 'Yes' : 'No';
            row.insertCell(8).textContent = rowData.vaccinated ? 'Yes' : 'No';
            row.insertCell(9).textContent = rowData.approved ? 'Approved' : 'Unapproved';

            const approveButton = document.createElement('button');
            if (approveButton.textContent = rowData.approved) {
                approveButton.className = 'btn btn-sm btn-danger';
                approveButton.textContent = 'Unapprove';
            } else {
                approveButton.className = 'btn btn-sm btn-primary';
                approveButton.textContent = 'Approve';
            }
            approveButton.addEventListener('click', function() {
                handleApprovalStatus(key, rowData, StatusEnum.PET_ADMIN_APPROVED, StatusEnum.PET_ADMIN_UNAPPROVED);           
            });
            row.insertCell(10).appendChild(approveButton);
        }

        // Function to populate a table row with data for adopted pets
        function populateAdoptedPetsTableRow(row, rowData, key) {

            row.insertCell(0).textContent = rowData.name;
            row.insertCell(1).textContent = rowData.age;
            row.insertCell(2).textContent = rowData.gender;
            row.insertCell(3).innerHTML = `<img src="${rowData.imageUrl}" alt="Pet Image" style="max-width: 100px; max-height: 100px;">`;
            const ownerCell = row.insertCell(4);
            database.ref('users/' + rowData.userId).once('value').then(function(userSnapshot) {
                const userData = userSnapshot.val();
                if (userData) {
                    ownerCell.textContent = userData.name;
                } else {
                    ownerCell.textContent = 'Unknown';
                }
            });
            const fosterCell = row.insertCell(5);
            database.ref('users/' + rowData.fosterId).once('value').then(function(userSnapshot) {
                const userData = userSnapshot.val();
                if (userData) {
                    fosterCell.textContent = userData.name;
                } else {
                    fosterCell.textContent = 'N/A';
                }
            });
            row.insertCell(6).textContent = rowData.address;
            row.insertCell(7).textContent = rowData.breed;
            row.insertCell(8).textContent = rowData.description;
            row.insertCell(9).textContent = rowData.adopted ? 'Adopted' : 'Unadopted';
            row.insertCell(10).textContent = rowData.approved ? 'Approved' : 'Unapproved';

            const approveButton = document.createElement('button');
            if (approveButton.textContent = rowData.approved) {
                approveButton.className = 'btn btn-sm btn-danger';
                approveButton.textContent = 'Unapprove';
            } else {
                approveButton.className = 'btn btn-sm btn-primary';
                approveButton.textContent = 'Approve';
            }
            approveButton.addEventListener('click', function() {
                handleApprovalStatus(key, rowData, StatusEnum.ADOPTION_ADMIN_APPROVED, StatusEnum.ADOPTION_ADMIN_UNAPPROVED);           
            });
            row.insertCell(11).appendChild(approveButton);
        }

        // Function to populate a table row with data for lost pets
        function populateLostPetsTableRow(row, rowData, key) {

            row.insertCell(0).textContent = rowData.name;
            row.insertCell(1).textContent = rowData.age;
            row.insertCell(2).textContent = rowData.gender;
            row.insertCell(3).innerHTML = `<img src="${rowData.imageUrl}" alt="Pet Image" style="max-width: 100px; max-height: 100px;">`;
            const ownerCell = row.insertCell(4);
            database.ref('users/' + rowData.userId).once('value').then(function(userSnapshot) {
                const userData = userSnapshot.val();
                if (userData) {
                    ownerCell.textContent = userData.name;
                } else {
                    ownerCell.textContent = 'Unknown';
                }
            });
            row.insertCell(5).textContent = rowData.contact;
            row.insertCell(6).textContent = rowData.address;
            row.insertCell(7).textContent = rowData.breed;
            row.insertCell(8).textContent = rowData.description;
            row.insertCell(9).textContent = rowData.lost ? 'Lost' : 'Found';
            row.insertCell(10).textContent = rowData.approved ? 'Approved' : 'Unapproved';

            const approveButton = document.createElement('button');
            if (approveButton.textContent = rowData.approved) {
                approveButton.className = 'btn btn-sm btn-danger';
                approveButton.textContent = 'Unapprove';
            } else {
                approveButton.className = 'btn btn-sm btn-primary';
                approveButton.textContent = 'Approve';
            }
            approveButton.addEventListener('click', function() {
                handleApprovalStatus(key, rowData, StatusEnum.LOST_FOUND_ADMIN_APPROVED, StatusEnum.LOST_FOUND_ADMIN_UNAPPROVED);           
            });
            row.insertCell(11).appendChild(approveButton);
        }

        // Function to populate a table row with data
        function populateMemorialPetsTableRow(row, rowData, key) {
            row.insertCell(0).textContent = rowData.name;
            const ownerCell = row.insertCell(1);
            database.ref('users/' + rowData.userId).once('value').then(function(userSnapshot) {
                const userData = userSnapshot.val();
                if (userData) {
                    ownerCell.textContent = userData.name;
                } else {
                    ownerCell.textContent = 'Unknown';
                }
            });
            row.insertCell(2).textContent = rowData.birthYear;
            row.insertCell(3).textContent = rowData.deathYear;
            row.insertCell(4).textContent = rowData.post;
            row.insertCell(5).textContent = rowData.approved ? 'Approved' : 'Unapproved';

            const approveButton = document.createElement('button');
            if (approveButton.textContent = rowData.approved) {
                approveButton.className = 'btn btn-sm btn-danger';
                approveButton.textContent = 'Unapprove';
            } else {
                approveButton.className = 'btn btn-sm btn-primary';
                approveButton.textContent = 'Approve';
            }
            approveButton.addEventListener('click', function() {
                handleApprovalStatus(key, rowData, StatusEnum.MEMORIAL_ADMIN_APPROVED, StatusEnum.MEMORIAL_ADMIN_UNAPPROVED);           
            });
            row.insertCell(6).appendChild(approveButton);
        }

        // Function to populate a table row with data
        function populateUsersTableRow(row, rowData, key) {

            row.insertCell(0).textContent = rowData.name;
            row.insertCell(1).textContent = rowData.emailAddress;
            row.insertCell(2).textContent = rowData.phone;
            row.insertCell(3).textContent = rowData.username;
        }

        // Function to update the table
        function updateTable() {
            if (currentPage === 'registered_pets') {
                $('#petsTable').DataTable();
            } else if (currentPage === 'adopted_pets') {
                $('#adoptedPetsTable').DataTable();
            } else if (currentPage === 'lost_pets') {
                $('#lostPetsTable').DataTable();
            } else if (currentPage === 'pet_memorials') {
                $('#memorialPetsTable').DataTable();
            } else if (currentPage === 'users') {
                $('#usersTable').DataTable();
            }
        }

    </script>
</body>
</html>
